apiVersion: batch/v1
kind: Job
metadata:
  name: mongodb-init-replica-set
  namespace: wikimedia
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: mongodb-init
          image: mongo:7.0
          command:
            - /bin/bash
            - -c
            - |
              sleep 30

              echo "Waiting for MongoDB instances to be ready..."
              until mongosh --host mongodb-0.mongodb-headless --eval "db.adminCommand('ping')" --quiet; do
                echo "Waiting for mongodb-0..."
                sleep 5
              done

              until mongosh --host mongodb-1.mongodb-headless --eval "db.adminCommand('ping')" --quiet; do
                echo "Waiting for mongodb-1..."
                sleep 5
              done

              until mongosh --host mongodb-2.mongodb-headless --eval "db.adminCommand('ping')" --quiet; do
                echo "Waiting for mongodb-2..."
                sleep 5
              done

              echo "All MongoDB instances are ready. Initializing replica set..."

              mongosh --host mongodb-0.mongodb-headless -u "$MONGO_ROOT_USERNAME" -p "$MONGO_ROOT_PASSWORD" --authenticationDatabase admin <<EOF
              rs.initiate({
                _id: "rs0",
                members: [
                  { _id: 0, host: "mongodb-0.mongodb-headless.wikimedia.svc.cluster.local:27017", priority: 2 },
                  { _id: 1, host: "mongodb-1.mongodb-headless.wikimedia.svc.cluster.local:27017", priority: 1 },
                  { _id: 2, host: "mongodb-2.mongodb-headless.wikimedia.svc.cluster.local:27017", priority: 1 }
                ]
              });
              EOF

              echo "Replica set initialization completed."

              sleep 10

              mongosh --host mongodb-0.mongodb-headless -u "$MONGO_ROOT_USERNAME" -p "$MONGO_ROOT_PASSWORD" --authenticationDatabase admin --eval "rs.status()"
          env:
            - name: MONGO_ROOT_USERNAME
              valueFrom:
                secretKeyRef:
                  name: mongodb-secret
                  key: mongodb-root-username
            - name: MONGO_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mongodb-secret
                  key: mongodb-root-password
